# Setup

## Install the module

First add `@bg-dev/nuxt-auth` dependency to your project

::code-group

```bash [NPM]
npm install --save-dev @bg-dev/nuxt-auth
```

```bash [Yarn]
yarn add --dev @bg-dev/nuxt-auth
```

```bash [PNPM]
pnpm install --save-dev @bg-dev/nuxt-auth
```

::

Then, add `@bg-dev/nuxt-auth` to the `modules` section of `nuxt.config.ts`

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  // ...
  modules: ["@bg-dev/nuxt-auth"],
  // ...
});
```

## Frontend-only

The module has a built-in Backend for handling authentication and serving resources with authorization. It's built on top of Prisma ORM.

For more flexibility, the module provides a Frontend-only option that turns off the built-in Backend by excluding the server's handlers, utilities and middlewares and permits users to bring their own. The provided Backend can be internal, meaning as part of the application, or external.

This feature does not effect the Frontend implementation meaning same APIs and benefits (auto-redirection, auto-refresh of token) as the Full-stack implementation.

The specification for the Backend APIs is provided [here](https://app.swaggerhub.com/apis-docs/becem-gharbi/nuxt-auth).

To enable this feature, these config options should be set:

- `backendEnabled` set to `false`.
- `backendBaseUrl` set to `/` for internal Backend.

## Full-stack

In order to use the built-in backend server:

### 1. Install Prisma

If you have not done so already, add `prisma` dependency to your project.

::code-group

```bash [NPM]
npm install --save-dev prisma
```

```bash [Yarn]
yarn add --dev prisma
```

```bash [PNPM]
pnpm install --save-dev prisma
```

::

### 2. Initialize Prisma

If you have not done so already, initialize prisma in your project by running the following command in your terminal

```bash
npx prisma init
```

### 3. Add schema

Add the module's data models to `prisma/schema.prisma` depending on the database chosen.

::alert
:icon{name="ph:check-circle" width="20px" height="20px" style="margin-right: 3px;" } Note that each model can be extended to include additional fields as needed.
::

_SQL_

If you are using a SQL database, add the following to Prisma schema.

```prisma [prisma/schema.prisma]
model User {
  id                     Int                @id @default(autoincrement())
  name                   String
  email                  String             @unique
  picture                String
  role                   Role               @default(user)
  provider               Provider           @default(default)
  password               String?
  verified               Boolean            @default(false)
  suspended              Boolean            @default(false)
  requestedPasswordReset Boolean            @default(false)
  refreshTokens          RefreshToken[]
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  uid       String
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

enum Role {
  user
  admin
}

enum Provider {
  default
  google
}
```

_Mongo DB_

If you are using a MongoDB database, add the following to `prisma/schema.prisma`

```prisma [prisma/schema.prisma]

model User {
  id                     String            @id @default(auto()) @map("_id") @db.ObjectId
  name                   String
  email                  String            @unique
  picture                String
  role                   Role              @default(user)
  provider               Provider          @default(default)
  password               String?
  verified               Boolean           @default(false)
  suspended              Boolean           @default(false)
  requestedPasswordReset Boolean           @default(false)
  refreshTokens          RefreshToken[]
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
}

model RefreshToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  uid       String
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

enum Role {
  user
  admin
}

enum Provider {
  default
  google
}
```

### 4. Run migration

Run migration to reflect schema changes on your database & generate prisma client

_SQL_

For SQL databases, run the following command in your terminal

```bash
npx prisma migrate dev
```

_Mongo DB_

Since MongoDB does not support migrations, you can generate the prisma client by running the following command in your terminal

```bash
npx prisma db push
```

### 5. Expose client

Since `v2.5.0` the internal instantiated prisma client is deprecated and needs to be disabled by setting the config option `prisma` to `false`. This allows configuring the client externally as needed, for example adding extensions and drivers.

Add the following Nitro plugin to your application to expose the client via `event.context`:

```ts [server/plugins/prisma.ts]
import { PrismaClient } from "@prisma/client";

export default defineNitroPlugin((nitroApp) => {
  const prisma = new PrismaClient();

  nitroApp.hooks.hook("request", (event) => {
    event.context.prisma = prisma;
  });
});
```
